

pub mod shamir;
// pub mod machine;
// pub mod memory_proxy;
pub mod communicator;
pub mod test_field;

#[cfg(test)]
mod tests {
    macro_rules! exp_test {
        ( {$( {$x:expr, $y:expr, $z:expr} ),*} ) => {
            $(
                let temp = TestField { x: $x };
                assert_eq!(TestField::exp(temp, $y).x, $z);
            )*
        };
    }

    use super::*;
    use super::test_field::TestField;
    use super::shamir::Field;
    use std::time;

    #[test]
    fn modular_inverse() {
        let now = time::Instant::now();

        for _ in 0..1000000 {
            let x = TestField::rand_elem();
            assert_eq!(TestField::mul_inv(x) * x, TestField::mul_identity());
        }

        println!("modular_inverse: {}", now.elapsed().as_secs());
    }

    #[test]
    fn share_and_combine() {
        let now = time::Instant::now();

        for _ in 0..100000 {
            let x = TestField::rand_elem();

            if let Ok(shares) = shamir::split(x, 5, 10) {
                if let Ok(secret) = shamir::join(&shares[0..5], 5) {
                    assert_eq!(x, secret);
                } else { panic!("wrong number of shares given to join"); }
            } else { panic!("wrong n given to split"); }
        }

        println!("share_and_combine: {}", now.elapsed().as_secs());
    }

    #[test]
    fn exponentiation() {
        let now = time::Instant::now();

        exp_test!({{403882146,704020972,1294018229},{2124338378,4194202352,2066254159},{318229717,3231526663,2243922348},{1859023887,154588148,2278262156},{2424208919,2406375382,2505244236},{3612532871,3835263670,151617683},{1516946067,682611580,774475175},{335283767,2338057542,1005427676},{1079735206,3436613210,3276878190},{2552126846,547185756,2210394353},{136485850,3649021325,3857692149},{2500365764,3570250424,2678866305},{706515058,2283536514,2227488044},{3196939892,2137740122,1904245983},{490704900,2640388089,305793058},{208213832,3339644923,1320781189},{2791989927,4238191102,1884654233},{3135564847,1000282053,3099268233},{486197008,3607522350,1128891758},{1206311848,3892415044,4208852499},{3897363763,2865095656,416229975},{2350225945,3396507005,3213669153},{2506377911,124383372,1243348903},{81105142,2201082718,3748231219},{1607552052,1052375859,1920636346},{3869963055,4203458862,1032119960},{2553698735,1767209054,3481723905},{3451492922,2769396509,210948273},{396934476,2414942933,3406357976},{3552295281,606852152,3706741290},{1047182008,336196658,3435573351},{237498963,2976929317,2341861652},{3071889111,1532956766,654460657},{1318508088,2078001648,2698585896},{1920696339,715876740,60591224},{2280516788,2308515056,2787408114},{1893108322,3763974263,2236816057},{3576638770,301217694,1941944462},{2547389064,2648623698,342778136},{3644661952,2810283581,2442116440},{1060451625,3115121300,693843983},{3383699702,2932824897,195674768},{718154518,2653699842,1706126188},{3812270516,3854281236,3902791581},{2659580305,475099570,625857781},{1578407438,2649266487,2838249878},{3698968513,3689011820,3635401590},{2370631298,1239464715,1535756193},{4124031546,529938496,841326606},{952936509,3543056712,1865409574},{1440853332,2515434228,1660342526},{1276794917,3213204578,1650318906},{2490642954,1948816614,1075648629},{1868714176,1955031463,2976676071},{4081763907,1334906513,1812594765},{3052087810,2769073120,2360151963},{583309996,1496152588,3699724061},{2021633657,912980086,1572553697},{1178926882,2910068564,3492864309},{611392808,3432742984,3591048517},{2976506054,2409447748,675835568},{1392682789,3177892841,3308143743},{3233686450,1404612253,4182871686},{1894961712,2425103237,72590782},{646178406,3364842790,4272547703},{3124701937,73579575,4232823365},{234743677,3411635762,4130693501},{1434887142,678876778,2441996921},{4138528650,3215471770,4078321605},{1718000660,1950356857,4073623964},{521346779,2947716962,2426481855},{2624071863,782097422,3632974908},{1998050442,1286612255,853585148},{1324370740,3701131644,1482760546},{1062563881,606501980,3773090950},{1974665270,2364903715,2963965137},{2673500592,1363578988,771519517},{573550045,2377581141,2702441980},{2226329958,1688906586,1553729046},{3063982815,2351007537,3158815046},{680275158,736733620,3588839709},{1195140053,3986793020,2813717679},{2052326047,2326462975,3232284645},{3484261994,154012511,1251294458},{3625694491,2571637894,3171593363},{3803568149,445053885,3108661657},{2599936408,2702487826,2898671961},{1069560547,1101926991,3890501044},{2622323994,4044746971,2496569916},{1131475436,493085285,1373455191},{2336415532,141767261,588758131},{1405385019,1612143268,908094016},{3443214904,4117269956,1468065496},{1824670139,2789170499,386877198},{3899234185,3424732197,1022181871},{728684358,3866311293,538845022},{2653809857,2737883581,1861336144},{2360954206,2596455842,2484804766},{3931438365,764787736,3308155559},{2309194966,1392812754,219670863},{1274978822,1970567992,1046490171},{3328173086,2062782496,854411817},{3371270649,1388167377,1578306682},{639293925,50189020,1931152186},{3110640721,616096589,3874523122},{87461049,2255932797,3499090276},{2842407942,973874811,1403830854},{3990964262,3613827906,1869141268},{1236842026,2925674349,3371995672},{3781105935,3171269996,3034993203},{494225933,3036980069,1274003105},{2340490110,1579532298,2218992355},{2241643254,2407930536,2710001498},{3927849402,1919624501,1345901025},{3411115801,1276023440,3598034241},{2543435397,3147511241,3614061132},{1721387963,2720326597,3356814847},{998775276,1269064481,2812102798},{3577968514,268823155,754362956},{4090074708,1864075415,3060487437},{3033215146,956676726,1453624931},{1901441752,1778576780,1513658971},{1707023799,2628000219,1114122644},{3544897215,3674608052,3574603599},{2095977443,2485150161,83112514},{564497594,2623938403,2033239284},{1216239027,1402341259,2744543994},{4116257837,200770880,2616021837},{8632126,3318574065,1221087935},{594434502,1226553498,1851259646},{3309526634,3456432772,280239020},{1988642538,3747611680,1881959155},{3174497273,4263213628,475846547},{3091236757,2710654908,1857457923},{2444514234,3557146192,1038479467},{482232172,4273854838,1935525995},{3589806151,1642902409,244540363},{2215081916,1635085391,717271936},{782415493,1008367721,3806637405},{1668109847,2944926629,2010256346},{2113249036,1300536069,2970198830},{871192426,1633403318,2547710821},{551436988,4018485540,2664481605},{3459467902,2967745847,815533332},{2855305671,2070781772,205133015},{2358274941,3072550539,2230002377},{1960060828,3903868983,3497008097},{1814939266,846067250,48724906},{364730097,3229674908,468882856},{2667135713,2067350326,3029863905},{657529685,2260724767,924336163},{663836995,3453362226,390385301},{3173240892,3020547729,3951500803},{1139730362,2138138788,3729327666},{2051418319,1084886222,2851585609},{4282996050,2965651353,2551016736},{2722493288,2455026003,858824620},{238898566,1646604181,1521993967},{1862685013,312570066,2109236883},{3617179247,4286416211,1004089294},{453160985,1199205825,551148316},{159993092,881444735,122411906},{303560237,1595859558,4164861797},{3429965048,819965499,1764279492},{3677258279,1966817280,2462642458},{3940374459,3128329107,3077223962},{634869902,3501461558,383996388},{3021741726,36565377,4215246048},{1253142814,1386602711,516246244},{2202667076,2099964481,99182495},{3897541600,1905780733,3215654518},{4088510586,181873682,2891062033},{3286172044,734772292,302161829},{3058017322,2417065632,3584022541},{1634049806,3681750103,597724548},{307444749,4226691146,1396422294},{1880261095,2137896990,2800466534},{1577010367,2204856723,2403544897},{1599546854,4148645777,2983435319},{3439655187,3319414415,4116750912},{813542103,3086968510,3311834048},{3475975594,1502235059,3983342397},{3009752426,3844830082,4187595773},{3276500582,1542456421,3980942508},{3523398576,2926996042,3632655621},{3324803707,3055851099,1258969007},{3928903894,3615766429,4238171071},{2023094124,1400546953,2321513},{2189706939,3460776381,2198217451},{40424610,1390768864,1451058418},{197897087,2040933231,328617199},{819340386,2285029775,901636476},{1511695216,4182336454,742365587},{157806391,3653870596,462460279},{2196150466,2959410828,1138848967},{2559582405,4253963935,4232268911},{4131927730,3276204670,3880786300},{187773260,3611709237,1028546380},{3740737503,472158004,3423058057},{3655146639,750829723,2560689782},{1276314265,154430113,184610932},{1749196060,1440371744,2746051829},{1317314959,2936924717,973753505},{295276281,1485602666,3210877169},{279424159,1390339528,2861222155},{1083257328,3719698805,1227057303},{2216206590,2152869949,1382674845},{341755988,1121865918,204659299},{3948911416,2902081662,3725139847},{3111268004,259130458,4284451143},{2792100828,757208486,710623487},{1978472711,1245302134,942452430},{698492482,2426169458,1862228664},{3774120753,1627624037,1365057569},{890222782,1905575533,665442939},{1048019668,795843887,2948547327},{28697997,1181777103,3148935517},{3372026425,1178169343,2855865870},{3772198236,3322349374,4162340139},{1000478271,483120292,3762853146},{2674971163,1898355594,3945393067},{2005441045,533771084,2330544598},{3957016109,2328539754,271204745},{2605479770,1786725781,967741370},{2369667691,712526734,2488539844},{497929719,1324650346,2791441673},{2181023832,3649534054,1162706069},{3410548476,2096162541,1919964066},{1372767056,1112243938,2572847642},{281870532,4061418982,41250519},{131050717,2017512958,1196017712},{3867168742,3682728714,2438850040},{3569738011,3755396027,3971395922},{2975074537,1246379893,2326659041},{362493355,1136178956,2479467781},{394251454,1541577325,1067322645},{3143005811,58191305,569478899},{3575122530,474433972,2823996063},{1706232929,2185557091,3044802267},{173677511,3316324589,159797429},{3059222044,2285823491,3121174473},{1964443218,2080669481,319086521},{3639394509,1509781689,2500005378},{3690751175,3808896324,1426788861},{4259814827,3504555440,2097884858},{3285021327,1638233752,3882574138},{362292004,3336603470,1369835790},{3165934145,3567523039,2501156218},{212761161,4090947095,1909367251},{68688073,3266869514,3106113424},{2415912978,3965528030,1462733894},{129526324,3011131744,467848201},{3194669547,2144588690,2202145608},{3890754503,1764210773,1706126650},{463091346,3952611217,2150488959},{2440160590,4262004041,1279654198},{1850793010,2014286588,2907811619},{677699769,241378612,1219854495},{312531502,515319248,2951510333},{1382862770,2329395727,3926345554},{596818787,2217079900,1619002173},{3546448406,3311588679,549516891},{2464236279,3874793130,1993711807},{134278617,139746337,3217662778},{3908531801,3967961444,2250617447},{34291214,3988251920,4113563951},{3853460737,2915411470,2252623161},{1405803837,2608628184,2116354328},{966372297,3861255607,2017021077},{2562235556,3084361329,2330339210},{2766107640,4000725727,1510476919},{3885464132,646168232,1358284845},{4112073859,3596825014,2074905572},{1911619514,2543792755,3553165198},{191613614,4233977671,152402920},{150651491,3067693774,2403070302},{670102823,1931830729,832023069},{3800119969,3417852644,3892564152},{4048765288,1110970439,3988673959},{3529126490,2205265526,2535905767},{3001916923,3575172548,3475016641},{3207532926,1296640787,1295675100},{4135211065,1554304884,4183191240},{2591837332,1488433330,2183237917},{839709772,2057716450,885137376},{197622578,1757897562,2940156065},{1325699277,2769342030,3233565085},{2873342911,2752509141,3500511643},{779859168,3567349768,2369793426},{283173544,2493404300,2827323955},{3989801088,1394171421,4177705361}});
        println!("exponentiation: {}", now.elapsed().as_secs());
    }
}